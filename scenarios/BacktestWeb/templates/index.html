<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurador de Backtest - Sistema Profesional</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .container { max-width: 1400px; margin-top: 20px; margin-bottom: 50px; }
        .card { border: none; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); }
        .nav-tabs .nav-link { color: #495057; font-weight: 500; border: none; padding: 12px 20px; }
        .nav-tabs .nav-link.active { color: #0d6efd; border-bottom: 3px solid #0d6efd; background: transparent; }
        
        /* ESTILOS DEL VISOR DE TABLAS CSV */
        #fileContent { 
            background: #1a1a1a; 
            min-height: 500px; 
            max-height: 80vh; 
            overflow: auto; 
            color: #e0e0e0;
            border-radius: 0 0 5px 5px;
        }

        .csv-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-size: 0.85rem; 
        }

        .csv-table th { 
            position: sticky; 
            top: 0; 
            background: #2d3436; 
            color: #00d4ff; 
            padding: 12px; 
            border: 1px solid #444; 
            z-index: 10;
            text-align: left;
            text-transform: uppercase;
        }

        .csv-table td { 
            padding: 8px 12px; 
            border: 1px solid #333; 
            white-space: nowrap; 
        }

        .csv-table tr:nth-child(even) { background: #212121; }
        .csv-table tr:hover { background: #2c3e50; }

        .folder { cursor: pointer; color: #f39c12; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .nested { margin-left: 24px; border-left: 1px dashed #ccc; padding-left: 10px; }
        .file-link { cursor: pointer; color: #0d6efd; text-decoration: none; }
        .file-link:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <div class="card bg-white p-4 rounded shadow">
        <h2 class="mb-4 text-center text-primary"><i class="bi bi-cpu-fill"></i> Panel de Configuraci√≥n Backtest</h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
                  {{ message|safe }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('main.index') }}" id="config-form">
            
            <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
                <li class="nav-item"><button class="nav-link active" id="tab-global" data-bs-toggle="tab" data-bs-target="#panel-global" type="button">Globales</button></li>
                <li class="nav-item"><button class="nav-link" id="tab-symbols" data-bs-toggle="tab" data-bs-target="#panel-symbols" type="button">Activos</button></li>
                <li class="nav-item"><button class="nav-link" id="tab-ema" data-bs-toggle="tab" data-bs-target="#panel-ema" type="button">EMA</button></li>
                <li class="nav-item"><button class="nav-link" id="tab-rsi" data-bs-toggle="tab" data-bs-target="#panel-rsi" type="button">RSI</button></li>
                <li class="nav-item"><button class="nav-link" id="tab-macd" data-bs-toggle="tab" data-bs-target="#panel-macd" type="button">MACD</button></li>
                <li class="nav-item"><button class="nav-link" id="tab-stoch" data-bs-toggle="tab" data-bs-target="#panel-stoch" type="button">Estoc√°stico</button></li>
                <li class="nav-item"><button class="nav-link" id="tab-bb" data-bs-toggle="tab" data-bs-target="#panel-bb" type="button">B. Bollinger</button></li>
                <li class="nav-item"><button class="nav-link" id="tab-volume" data-bs-toggle="tab" data-bs-target="#panel-volume" type="button">Volumen</button></li>
                <li class="nav-item"><button class="nav-link fw-bold text-success" id="tab-files" data-bs-toggle="tab" data-bs-target="#panel-files" type="button"><i class="bi bi-folder2-open"></i> FICHEROS</button></li>
            </ul>

            <div class="tab-content p-3 border rounded shadow-sm bg-light" id="configTabsContent">
                <div class="tab-pane fade show active" id="panel-global">{% include '_tab_global.html' %}</div>
                <div class="tab-pane fade" id="panel-symbols">{% include '_tab_symbols.html' %}</div>
                <div class="tab-pane fade" id="panel-ema">{% include '_tab_ema.html' %}</div>
                <div class="tab-pane fade" id="panel-rsi">{% include '_tab_rsi.html' %}</div>
                <div class="tab-pane fade" id="panel-macd">{% include '_tab_macd.html' %}</div>
                <div class="tab-pane fade" id="panel-stoch">{% include '_tab_stoch.html' %}</div>
                <div class="tab-pane fade" id="panel-bb">{% include '_tab_bb.html' %}</div>
                <div class="tab-pane fade" id="panel-volume">{% include '_tab_mos_volume.html' %}</div>
                <div class="tab-pane fade" id="panel-files">{% include '_tab_ficheros.html' %}</div>
            </div>

            <div class="row mt-5 mb-5">
                <div class="col-12 d-flex gap-3">
                    <button type="submit" form="config-form" class="btn btn-success flex-fill py-3 shadow-sm fw-bold">
                        <i class="bi bi-save"></i> Guardar Configuraci√≥n
                    </button>

                    <a href="{{ url_for('main.logout') }}" class="btn btn-outline-secondary flex-fill py-3 shadow-sm d-flex align-items-center justify-content-center fw-bold">
                        <i class="bi bi-box-arrow-left me-2"></i> Cerrar Sesi√≥n
                    </a>

                    <button type="button" onclick="lanzarEstrategia()" class="btn btn-primary flex-fill py-3 shadow-sm fw-bold">
                        <i class="bi bi-play-fill"></i> Lanzar Backtest
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="csvViewerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="csvViewerTitle">Visualizador de Datos</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div id="fileContent"></div>
            </div>
        </div>
    </div>
</div>

<form id="formDelete" method="POST" style="display:none;"></form>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 1. LIMPIEZA DE DATOS Y PERSISTENCIA DE PESTA√ëAS
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('input').forEach(input => {
            if (input.value === "None") input.value = "";
        });

        const savedTab = localStorage.getItem('activeTabKey');
        if (savedTab) {
            const triggerEl = document.querySelector(`#${savedTab}`);
            if (triggerEl) bootstrap.Tab.getOrCreateInstance(triggerEl).show();
        }

        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tabBtn => {
            tabBtn.addEventListener('shown.bs.tab', (e) => {
                localStorage.setItem('activeTabKey', e.target.id);
            });
        });
    });

    // 2. APERTURA DE ARCHIVOS
    function openFile(url, filename) {
        if (filename.toLowerCase().endsWith('.html')) {
            window.open(url + '?cache=' + Date.now(), '_blank');
            return;
        }

        const modalElement = document.getElementById('csvViewerModal');
        const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
        const displayArea = document.getElementById('fileContent');
        
        document.getElementById('csvViewerTitle').innerHTML = `<i class="bi bi-file-earmark-spreadsheet"></i> ${filename}`;
        displayArea.innerHTML = '<div class="p-5 text-center text-info"><div class="spinner-border text-primary mb-2"></div><br>Construyendo tabla...</div>';
        modalInstance.show();

        fetch(url + '?nocache=' + Date.now())
            .then(response => {
                if (!response.ok) throw new Error("Error de carga");
                return response.text();
            })
            .then(rawContent => {
                if (filename.toLowerCase().endsWith('.csv')) {
                    displayArea.innerHTML = buildHtmlTableFromCsv(rawContent);
                } else {
                    displayArea.innerHTML = `<pre class="p-4 m-0 text-white" style="font-size:12px;">${rawContent}</pre>`;
                }
            })
            .catch(error => {
                displayArea.innerHTML = `<div class="p-4 text-danger">Error: ${error.message}</div>`;
            });
    }

    // 3. RENDER CSV
    function buildHtmlTableFromCsv(text) {
        const rows = text.trim().split(/\r?\n/);
        if (rows.length === 0) return '<div class="p-4">Sin datos.</div>';
        const delimiter = rows[0].includes(';') ? ';' : ',';
        let tableHtml = '<table class="csv-table"><thead><tr>';
        const headers = rows[0].split(delimiter);
        headers.forEach(h => {
            tableHtml += `<th>${h.replace(/["']/g, '').trim()}</th>`;
        });
        tableHtml += '</tr></thead><tbody>';
        for (let i = 1; i < rows.length; i++) {
            if (!rows[i].trim()) continue;
            const cells = rows[i].split(delimiter);
            tableHtml += '<tr>';
            cells.forEach(c => {
                tableHtml += `<td>${c.replace(/["']/g, '').trim()}</td>`;
            });
            tableHtml += '</tr>';
        }
        tableHtml += '</tbody></table>';
        return tableHtml;
    }

    // 4. LANZAR ESTRATEGIA (BOT√ìN AZUL)
    function lanzarEstrategia() {
        const launchBtn = document.querySelector('button[onclick="lanzarEstrategia()"]');
        const originalHtml = launchBtn.innerHTML;
        
        launchBtn.disabled = true;
        launchBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Ejecutando...';

        fetch("{{ url_for('main.launch_strategy') }}", { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    // Guardamos la pesta√±a de FICHEROS como activa para el refresco
                    localStorage.setItem('activeTabKey', 'tab-files');
                    
                    // Peque√±a notificaci√≥n antes de recargar
                    alert("‚úÖ " + data.message);
                    
                    // Refresco forzoso para leer nuevas fechas de archivos
                    location.reload();
                } else {
                    alert("‚ùå Error: " + data.message);
                }
            })
            .catch(() => alert("Error al contactar con el servidor."))
            .finally(() => {
                launchBtn.disabled = false;
                launchBtn.innerHTML = originalHtml;
            });
    }

    function toggleFolder(folderElement) {
        const nestedDiv = folderElement.parentElement.querySelector(".nested");
        if (nestedDiv) {
            const isHidden = nestedDiv.style.display === "none";
            nestedDiv.style.display = isHidden ? "block" : "none";
            folderElement.innerHTML = isHidden ? folderElement.innerHTML.replace("üìÅ", "üìÇ") : folderElement.innerHTML.replace("üìÇ", "üìÅ");
        }
    }

    function confirmDelete(deleteUrl, name) {
        if (confirm(`¬øEliminar permanentemente "${name}"?`)) {
            const formDel = document.getElementById('formDelete');
            formDel.action = deleteUrl;
            formDel.submit();
        }
    }
</script>

</body>
</html>