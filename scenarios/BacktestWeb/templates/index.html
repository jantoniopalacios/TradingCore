<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingCore Pro | Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root { --sb-width: 240px; --dark-bg: #0f172a; --accent: #2563eb; }
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; font-size: 13px; margin: 0; }
        
        /* Sidebar Estilizada */
        .sidebar { width: var(--sb-width); background: var(--dark-bg); height: 100vh; position: fixed; padding: 1.5rem; color: #f8fafc; z-index: 1050; }
        .main-content { margin-left: var(--sb-width); padding: 1.5rem; width: calc(100% - var(--sb-width)); min-height: 100vh; }
        
        /* Navegaci√≥n Sidebar */
        .nav-sidebar .nav-link { font-size: 12px; color: #94a3b8; border-radius: 8px; margin-bottom: 5px; text-align: left; width: 100%; border: none; background: transparent; transition: 0.2s; }
        .nav-sidebar .nav-link.active { background: var(--accent); color: white; }
        .nav-sidebar .nav-link:hover:not(.active) { background: rgba(255,255,255,0.05); color: white; }
        
        /* Contenedores y Cards */
        .card-main { background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .nav-sub { background: #f1f5f9; border-radius: 8px; padding: 4px; margin-bottom: 20px; display: inline-flex; flex-wrap: wrap; }
        .nav-sub .nav-link { font-size: 11px; padding: 6px 14px; border: none; color: #64748b; font-weight: 600; text-transform: uppercase; border-radius: 6px; background: transparent; }
        .nav-sub .nav-link.active { background: white; color: var(--accent); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        /* Visor de Archivos (CSV Table y Logs) */
        #fileContent { 
            background: #000000 !important; /* Negro total para mejor contraste de logs */
            min-height: 500px; 
            max-height: 80vh; 
            overflow: auto; 
            color: #e0e0e0; 
            border-radius: 6px; 
        }

        .csv-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 11px; 
        }

        .csv-table th { 
            position: sticky; 
            top: 0; 
            background: #1a1a1a; /* Fondo oscuro para el header sticky */
            color: #00d4ff; 
            padding: 12px; 
            border: 1px solid #333; 
            z-index: 10; 
            text-align: left; 
        }

        .csv-table td { 
            padding: 8px 12px; 
            border: 1px solid #222; 
            white-space: pre-wrap; /* CAMBIO CLAVE: Permite que los mensajes largos de log bajen de l√≠nea */
            word-break: break-all;
            vertical-align: top;
        }

        .csv-table td:first-child {
            white-space: nowrap !important; /* El timestamp nunca debe romperse en dos l√≠neas */
            border-right: 1px solid #333;
        }

        .log-msg {
            word-break: break-all;   /* Rompe URLs largas si es necesario */
            white-space: normal;    /* Permite que el texto largo salte de l√≠nea */
        }

        .csv-table tr:nth-child(even) { background: #0a0a0a; }
        .csv-table tr:hover { background: #16213e; } /* Azul oscuro sutil al pasar el mouse */

        /* Estilo para los Badges de nivel en el log */
        .badge {
            font-size: 0.75rem;
            padding: 0.35em 0.65em;
            font-weight: 600;
        }

        /* Explorador de archivos */
        .folder { cursor: pointer; color: #f39c12; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .nested { margin-left: 20px; border-left: 1px dashed #cbd5e1; padding-left: 10px; display: none; }

        /* Animaci√≥n para el desplegable de Tandas */
        .toggle-icon { transition: transform 0.3s; display: inline-block; }
        tr[aria-expanded="true"] .toggle-icon { transform: rotate(90deg); }
        .bg-tanda { background-color: #f1f5f9 !important; border-left: 4px solid #2563eb; }
        .sub-table-container { background: white; padding: 15px; border-radius: 0 0 8px 8px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
    
        .tab-pane.fade {
            transition: opacity 0.2s ease-in-out; /* Transici√≥n m√°s r√°pida y suave */
        }

        .tab-pane.active {
            display: block;
        }

        /* Evita el salto visual al cambiar de pesta√±a */
        .card-main {
            min-height: 500px; /* Asegura que el contenedor no colapse al cambiar */
            transition: all 0.3s ease;
        }

        /* Efecto hover suave en las sub-pesta√±as */
        .nav-sub .nav-link:hover {
            background-color: rgba(255,255,255,0.5);
        }
    </style>

</head>
<body>

<div class="sidebar d-flex flex-column">
    <div class="mb-4 px-1 d-flex align-items-center">
        <i class="bi bi-lightning-charge-fill text-primary fs-4 me-2"></i>
        <h5 class="fw-bold text-white mb-0">TRADINGCORE <span class="text-primary">PRO</span></h5>
    </div>

    <div class="mx-1 mb-4 p-2 rounded-3 border border-secondary border-opacity-25" style="background: rgba(255,255,255,0.03);">
        <div class="d-flex align-items-center">
            <div class="position-relative">
                <i class="bi bi-person-circle fs-3 {{ 'text-info' if session.get('user_mode') == 'admin' else 'text-secondary' }}"></i>
                <span class="position-absolute bottom-0 end-0 p-1 bg-success border border-dark rounded-circle" style="width: 10px; height: 10px;"></span>
            </div>
            <div class="ms-2 overflow-hidden">
                <p class="text-muted mb-0 fw-bold" style="font-size: 9px; letter-spacing: 0.5px; text-transform: uppercase;">Sesi√≥n Activa</p>
                <p class="text-white mb-0 small text-truncate fw-medium" title="{{ session.get('user_name', 'Invitado') }}">
                    {{ session.get('user_mode', 'Invitado') }}
                    {% if session.get('user_mode') == 'admin' %}
                        <i class="bi bi-patch-check-fill text-info ms-1" title="Administrador"></i>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <div class="nav flex-column nav-sidebar" id="mainTab" role="tablist">
        <button class="nav-link active" id="btn-nav-config" data-bs-toggle="tab" data-bs-target="#pane-config" type="button">
            <i class="bi bi-sliders me-2"></i> CONFIGURACI√ìN
        </button>
        
        <button class="nav-link" id="btn-nav-symbols" data-bs-toggle="tab" data-bs-target="#pane-symbols" type="button">
            <i class="bi bi-list-stars me-2"></i> LISTA ACTIVOS
        </button>
        
        <button class="nav-link" id="tab-master-files" data-bs-toggle="tab" data-bs-target="#pane-files" type="button">
            <i class="bi bi-folder2-open me-2"></i> EXPLORADOR
        </button>
        
        <button class="nav-link text-info fw-bold" id="tab-historial" data-bs-toggle="tab" data-bs-target="#pane-sql" type="button">
            <i class="bi bi-database me-2"></i> HISTORIAL SQL
        </button>
    </div>

    <div class="mt-auto pt-4 border-top border-secondary">
        <button type="button" onclick="lanzarEstrategia()" class="btn btn-primary w-100 fw-bold mb-3 shadow-sm">
            <i class="bi bi-play-fill me-1"></i> LANZAR BACKTEST
        </button>
        <button type="submit" form="config-form" name="action" value="save_config" class="btn btn-outline-light btn-sm w-100 opacity-75 mb-4">
            <i class="bi bi-save me-1"></i> GUARDAR CONFIG
        </button>
        
        <a href="{{ url_for('main.logout') }}" class="btn btn-outline-danger btn-sm w-100 border-0">
            <i class="bi bi-box-arrow-left me-2"></i>Cerrar Sesi√≥n
        </a>
    </div>
</div>

<div class="main-content">
    
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm mb-4" role="alert">
              {{ message|safe }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('main.index') }}" id="config-form">
        <div class="tab-content">
            
            <div class="tab-pane fade show active" id="pane-config">
                <div class="nav nav-pills nav-sub" id="subTabsConfig" role="tablist">
                    <button class="nav-link active" id="tab-global" data-bs-toggle="pill" data-bs-target="#sub-global">Global</button>
                    <button class="nav-link" id="tab-ema" data-bs-toggle="pill" data-bs-target="#sub-ema">EMA</button>
                    <button class="nav-link" id="tab-rsi" data-bs-toggle="pill" data-bs-target="#sub-rsi">RSI</button>
                    <button class="nav-link" id="tab-macd" data-bs-toggle="pill" data-bs-target="#sub-macd">MACD</button>
                    <button class="nav-link" id="tab-stoch" data-bs-toggle="pill" data-bs-target="#sub-stoch">Estoc√°stico</button>
                    <button class="nav-link" id="tab-bb" data-bs-toggle="pill" data-bs-target="#sub-bb">Bollinger</button>
                    <button class="nav-link" id="tab-volume" data-bs-toggle="pill" data-bs-target="#sub-volume">Volumen</button>
                </div>
                <div class="tab-content card-main">
                    <div class="tab-pane fade show active" id="sub-global">{% include '_tab_global.html' %}</div>
                    <div class="tab-pane fade" id="sub-ema">{% include '_tab_ema.html' %}</div>
                    <div class="tab-pane fade" id="sub-rsi">{% include '_tab_rsi.html' %}</div>
                    <div class="tab-pane fade" id="sub-macd">{% include '_tab_macd.html' %}</div>
                    <div class="tab-pane fade" id="sub-stoch">{% include '_tab_stoch.html' %}</div>
                    <div class="tab-pane fade" id="sub-bb">{% include '_tab_bb.html' %}</div>
                    <div class="tab-pane fade" id="sub-volume">{% include '_tab_mos_volume.html' %}</div>
                </div>
            </div>

            <div class="tab-pane fade" id="pane-symbols">
                <div class="card-main">{% include '_tab_symbols.html' %}</div>
            </div>

            <div class="tab-pane fade" id="pane-files">
                <div class="card-main">{% include '_tab_ficheros.html' %}</div>
            </div>

            <div class="tab-pane fade" id="pane-sql">
                <div class="card-main p-0 overflow-hidden">
                    {% include '_tab_historial.html' %}
                </div>
            </div>

        </div>
    </form>
</div>

<div class="modal fade" id="csvViewerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-dark text-white py-2">
                <h6 class="modal-title" id="csvViewerTitle">Visualizador</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="fileContent"></div>
            </div>
        </div>
    </div>
</div>

<form id="formDelete" method="POST" style="display:none;"></form>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 1. LIMPIEZA Y PERSISTENCIA (Tu l√≥gica original)
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('input').forEach(input => {
            if (input.value === "None") input.value = "";
        });

        const savedTab = localStorage.getItem('activeTabKey');
        if (savedTab) {
            const triggerEl = document.querySelector(`#${savedTab}`);
            if (triggerEl) bootstrap.Tab.getOrCreateInstance(triggerEl).show();
        }

        // PERSISTENCIA DE PESTA√ëAS
        const tabs = ['activeTabKey', 'activeSubTabKey'];
        tabs.forEach(key => {
            const savedTab = localStorage.getItem(key);
            if (savedTab) {
                const triggerEl = document.querySelector(`#${savedTab}`);
                if (triggerEl) {
                    const tab = new bootstrap.Tab(triggerEl);
                    tab.show();
                }
            }
        });

        // GUARDAR PESTA√ëA AL HACER CLIC
        document.querySelectorAll('button[data-bs-toggle="tab"], button[data-bs-toggle="pill"]').forEach(tabBtn => {
            tabBtn.addEventListener('shown.bs.tab', (e) => {
                // Si es una pesta√±a principal (pane-...)
                if (e.target.id.startsWith('btn-nav') || e.target.id.startsWith('tab-master')) {
                    localStorage.setItem('activeTabKey', e.target.id);
                } 
                // Si es una sub-pesta√±a (global, ema, rsi...)
                else {
                    localStorage.setItem('activeSubTabKey', e.target.id);
                }
            });
        });
    });

    function openFile(url, filename) {
        // Si es HTML, abrir en pesta√±a nueva como ya hac√≠as
        if (filename.toLowerCase().endsWith('.html')) {
            window.open(url + '?cache=' + Date.now(), '_blank');
            return;
        }
        
        const modalElement = document.getElementById('csvViewerModal');
        const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
        const displayArea = document.getElementById('fileContent'); // El ID correcto de tu HTML
        
        // T√≠tulo con icono
        document.getElementById('csvViewerTitle').innerHTML = `<i class="bi bi-terminal"></i> ${filename}`;
        
        // Spinner de carga
        displayArea.innerHTML = '<div class="p-5 text-center"><div class="spinner-border text-primary"></div><p class="text-white-50 mt-2">Cargando contenido...</p></div>';
        modalInstance.show();

        fetch(url + '?nocache=' + Date.now())
            .then(res => {
                if (!res.ok) throw new Error(`Error ${res.status}: No se pudo acceder al archivo`);
                return res.text();
            })
            .then(raw => {
                if (!raw || raw.trim() === "") {
                    displayArea.innerHTML = '<div class="p-5 text-center text-warning">--- El archivo est√° vac√≠o ---</div>';
                    return;
                }

                if (filename.toLowerCase().endsWith('.csv')) {
                    displayArea.innerHTML = buildHtmlTableFromCsv(raw);
                } else if (filename.toLowerCase().endsWith('.log')) {
                    // Verificamos si el log tiene el formato esperado (separado por " - ")
                    if (raw.includes(' - ')) {
                        displayArea.innerHTML = buildLogViewer(raw);
                    } else {
                        // Si el log no tiene el formato est√°ndar, lo mostramos como texto plano
                        displayArea.innerHTML = `<pre class="p-4 m-0 text-white" style="white-space: pre-wrap; font-family: 'JetBrains Mono', monospace; font-size: 12px;">${raw}</pre>`;
                    }
                } else {
                    displayArea.innerHTML = `<pre class="p-4 m-0 text-white" style="white-space: pre-wrap;">${raw}</pre>`;
                }
            })
            .catch(err => {
                displayArea.innerHTML = `<div class="alert alert-danger m-3">Error al cargar el archivo: ${err.message}</div>`;
            });
    }
    
    function buildLogViewer(text) {
        const lines = text.trim().split(/\r?\n/).filter(l => l.trim()).reverse();
        
        let html = `
            <div class="p-2 bg-black border-bottom border-secondary d-flex gap-2 sticky-top" style="top: 0; z-index: 100;">
                <input type="text" id="logSearch" class="form-control form-control-sm bg-dark text-white border-secondary" placeholder="Filtrar..." onkeyup="filterLogs()">
                <select id="logLevelFilter" class="form-select form-select-sm bg-dark text-white border-secondary" style="width:150px" onchange="filterLogs()">
                    <option value="">Todos los niveles</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                </select>
            </div>
            <table class="csv-table" id="logTable">
                <thead>
                    <tr>
                        <th style="width:180px; top: 45px;">Timestamp</th> 
                        <th style="width:100px; top: 45px;">Nivel</th>
                        <th style="top: 45px;">Mensaje</th>
                    </tr>
                </thead>
                <tbody>`;

        lines.forEach(line => {
            // Separamos por la barra vertical " | "
            const parts = line.split(' | ');

            if (parts.length >= 3) {
                const timestamp = parts[0].split(',')[0]; // Quitamos los milisegundos para que quede limpio
                const level = parts[1].trim();
                const message = parts.slice(2).join(' | '); // El resto es el mensaje
                
                let badgeClass = 'bg-info';
                if (level.includes('ERROR')) badgeClass = 'bg-danger';
                if (level.includes('WARNING')) badgeClass = 'bg-warning text-dark';
                
                html += `
                    <tr class="log-row" data-level="${level.toUpperCase()}">
                        <td class="text-warning font-monospace small" style="white-space: nowrap;">${timestamp}</td>
                        <td><span class="badge ${badgeClass}">${level.toUpperCase()}</span></td>
                        <td class="log-msg text-white-50" style="font-size: 11px;">${message}</td>
                    </tr>`;
            } else {
                // L√≠nea sin formato est√°ndar
                html += `
                    <tr class="log-row" data-level="INFO">
                        <td class="text-muted small">--:--:--</td>
                        <td><span class="badge bg-secondary">LOG</span></td>
                        <td class="log-msg text-white-50">${line}</td>
                    </tr>`;
            }
        });

        return html + '</tbody></table>';
    }

    // Funci√≥n de filtrado instant√°neo para la consola
    function filterLogs() {
        const search = document.getElementById('logSearch').value.toLowerCase();
        const level = document.getElementById('logLevelFilter').value;
        const rows = document.querySelectorAll('.log-row');

        rows.forEach(row => {
            const text = row.querySelector('.log-msg').textContent.toLowerCase();
            const rowLevel = row.getAttribute('data-level');
            const matchesSearch = text.includes(search);
            const matchesLevel = level === "" || rowLevel === level;
            row.style.display = (matchesSearch && matchesLevel) ? '' : 'none';
        });
    }

    // 3. RENDER CSV (Tu l√≥gica original)
    function buildHtmlTableFromCsv(text) {
        const rows = text.trim().split(/\r?\n/);
        if (rows.length === 0) return '<div class="p-4">Sin datos.</div>';
        const delimiter = rows[0].includes(';') ? ';' : ',';
        let tableHtml = '<table class="csv-table"><thead><tr>';
        rows[0].split(delimiter).forEach(h => tableHtml += `<th>${h.replace(/["']/g, '').trim()}</th>`);
        tableHtml += '</tr></thead><tbody>';
        for (let i = 1; i < rows.length; i++) {
            if (!rows[i].trim()) continue;
            tableHtml += '<tr>';
            rows[i].split(delimiter).forEach(c => tableHtml += `<td>${c.replace(/["']/g, '').trim()}</td>`);
            tableHtml += '</tr>';
        }
        return tableHtml + '</tbody></table>';
    }

    // 4. LANZAR ESTRATEGIA (Tu l√≥gica original)
    function lanzarEstrategia() {
        const launchBtn = document.querySelector('button[onclick="lanzarEstrategia()"]');
        const originalHtml = launchBtn.innerHTML;

        // 1. OBTENER EL FORMULARIO (Certeza: ID coincide con tu HTML)
        const formElement = document.getElementById('config-form');
        
        // 2. EMPAQUETAR LOS DATOS (Esto incluye lo de _tab_global.html, etc.)
        const formData = new FormData(formElement);

        launchBtn.disabled = true;
        launchBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>...';

        // 3. ENVIAR CON EL BODY LLENO
        fetch("{{ url_for('main.launch_strategy') }}", { 
            method: 'POST',
            body: formData  // <-- Certeza: Ahora el diccionario NO llegar√° vac√≠o
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                localStorage.setItem('activeTabKey', 'tab-historial');
                alert("‚úÖ " + data.message);
                location.reload();
            } else {
                alert("‚ùå Error: " + data.message);
            }
        })
        .catch(err => alert("‚ùå Error de red: " + err))
        .finally(() => {
            launchBtn.disabled = false;
            launchBtn.innerHTML = originalHtml;
        });
    }

    function toggleFolder(el) {
        const n = el.parentElement.querySelector(".nested");
        if (n) {
            const isH = n.style.display === "none" || n.style.display === "";
            n.style.display = isH ? "block" : "none";
            el.innerHTML = isH ? el.innerHTML.replace("üìÅ", "üìÇ") : el.innerHTML.replace("üìÇ", "üìÅ");
        }
    }

    function confirmDelete(event, url, name) {
    if (event) {
        event.stopPropagation(); // Detiene el despliegue de la fila
        event.preventDefault();
    }
    
    if (confirm(`¬øEliminar "${name}"?`)) {
        const f = document.getElementById('formDelete');
        f.action = url;
        f.submit();
    }
}

    function verTrades(backtestId, symbol) {

    const displayArea = document.getElementById('fileContent');
    const modalElement = document.getElementById('csvViewerModal');
    const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
    
    document.getElementById('csvViewerTitle').innerHTML = `<i class="bi bi-database"></i> Operaciones Detalladas: ${symbol}`;
    displayArea.innerHTML = '<div class="p-5 text-center"><div class="spinner-border text-primary"></div><p>Cargando trades desde SQL...</p></div>';
    modalInstance.show();

    // Llamada a la API de Flask
    fetch(`/get_trades/${backtestId}`)
        .then(res => res.json())
        .then(trades => {
            if (trades.length === 0) {
                displayArea.innerHTML = '<div class="alert alert-warning m-3">No hay operaciones registradas para este activo.</div>';
                return;
            }

            let html = `
                <table class="csv-table">
                    <thead>
                        <tr>
                            <th>TIPO</th>
                            <th>DESCRIPCI√ìN</th>
                            <th>FECHA</th>
                            <th>ENTRADA</th>
                            <th>SALIDA</th>
                            <th>PnL ABS</th>
                            <th>RETORNO %</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            trades.forEach(t => {
                const pnlClass = t.retorno >= 0 ? 'text-success' : 'text-danger';
                html += `
                    <tr>
                        <td><span class="badge ${t.tipo == 'Long' ? 'bg-success' : 'bg-danger'}">${t.tipo}</span></td>
                        <td class="small text">${t.descripcion || '-'}</td> 
                        <td>${t.fecha}</td>
                        <td>${t.entrada.toFixed(2)}</td>
                        <td>${t.salida.toFixed(2)}</td>
                        <td class="${pnlClass}">${t.pnl.toFixed(2)}</td>
                        <td class="${pnlClass}">${t.retorno.toFixed(2)}%</td>
                    </tr>`;
            });

            html += '</tbody></table>';
            displayArea.innerHTML = html;
        })
        .catch(err => {
            displayArea.innerHTML = `<div class="alert alert-danger m-3">Error al cargar datos: ${err}</div>`;
        });
    }
</script>
</body>
</html>