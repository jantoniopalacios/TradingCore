<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurador de Estrategia de Backtest</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        .container { max-width: 1300px; margin-top: 20px; margin-bottom: 50px; }
        .folder { cursor: pointer; font-weight: bold; color: #f39c12; }
        .folder:hover { color: #e67e22; }
        .text-muted { font-family: monospace; color: #6c757d !important; margin-right: 15px; }
        .text-danger { opacity: 0.6; transition: opacity 0.2s; }
        .text-danger:hover { opacity: 1; }
        .nav-link { cursor: pointer; }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="mb-4 text-center">âš™ï¸ ConfiguraciÃ³n del Backtest</h1>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mt-3">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message | safe }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('main.index') }}" id="configForm">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" id="global-tab" data-bs-toggle="tab" data-bs-target="#global" type="button">ğŸŒ Globales</button></li>
                <li class="nav-item"><button class="nav-link" id="symbols-tab" data-bs-toggle="tab" data-bs-target="#symbols" type="button">ğŸª™ Activos</button></li>
                <li class="nav-item"><button class="nav-link" id="ema-tab" data-bs-toggle="tab" data-bs-target="#ema" type="button">ğŸ“ˆ EMA</button></li>
                <li class="nav-item"><button class="nav-link" id="rsi-tab" data-bs-toggle="tab" data-bs-target="#rsi" type="button">ğŸ“Š RSI</button></li>
                <li class="nav-item"><button class="nav-link" id="macd-tab" data-bs-toggle="tab" data-bs-target="#macd" type="button">ğŸ“‰ MACD</button></li>
                <li class="nav-item"><button class="nav-link" id="stoch-tab" data-bs-toggle="tab" data-bs-target="#stoch" type="button">âš™ï¸ EstocÃ¡sticos</button></li>
                <li class="nav-item"><button class="nav-link" id="bb-tab" data-bs-toggle="tab" data-bs-target="#bb" type="button"><i class="bi bi-graph-up me-2"></i>BB</button></li>
                <li class="nav-item"><button class="nav-link" id="mosvolume-tab" data-bs-toggle="tab" data-bs-target="#mosvolume" type="button">ğŸ’° Margen / Volumen</button></li>
                <li class="nav-item"><button class="nav-link" id="ficheros-tab" data-bs-toggle="tab" data-bs-target="#ficheros" type="button"><i class="bi bi-folder-fill me-2"></i>Ficheros</button></li>
            </ul>
            
            <div class="tab-content border border-top-0 p-3" id="myTabContent">
                <div class="tab-pane fade show active" id="global" role="tabpanel">{% include '_tab_global.html' %}</div>
                <div class="tab-pane fade" id="symbols" role="tabpanel">{% include '_tab_symbols.html' %}</div>
                <div class="tab-pane fade" id="ema" role="tabpanel">{% include '_tab_ema.html' %}</div>
                <div class="tab-pane fade" id="rsi" role="tabpanel">{% include '_tab_rsi.html' %}</div>
                <div class="tab-pane fade" id="macd" role="tabpanel">{% include '_tab_macd.html' %}</div>
                <div class="tab-pane fade" id="bb" role="tabpanel">{% include '_tab_bb.html' %}</div>
                <div class="tab-pane fade" id="stoch" role="tabpanel">{% include '_tab_stoch.html' %}</div>
                <div class="tab-pane fade" id="mosvolume" role="tabpanel">{% include '_tab_mos_volume.html' %}</div>
                <div class="tab-pane fade" id="ficheros" role="tabpanel">{% include '_tab_ficheros.html' %}</div>
            </div>
            
            <div class="d-flex justify-content-between mt-4 mb-5">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="bi bi-save-fill me-2"></i> Guardar ConfiguraciÃ³n
                </button>

                <button type="button" id="btnLaunch" class="btn btn-primary btn-lg" onclick="launchBacktest()">
                    <i class="bi bi-rocket-fill me-2"></i> Ejecutar Backtest
                </button>
                
                <a href="{{ url_for('main.console') }}" target="_blank" class="btn btn-outline-dark">
                    <i class="fas fa-terminal"></i> Abrir Consola Live
                </a>
            </div>
        </form>

        <form method="POST" action="{{ url_for('main.launch_strategy') }}" id="launchForm" style="display:none;"></form>
        <form id="deleteFileForm" method="POST" style="display:none;"></form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // 1. PERSISTENCIA DE PESTAÃ‘AS (Mantiene la pestaÃ±a activa al recargar)
    document.addEventListener('DOMContentLoaded', function() {
        const activeTabId = localStorage.getItem('activeTab');
        if (activeTabId) {
            const tabTrigger = document.querySelector(`#${activeTabId}`);
            if (tabTrigger) {
                const tab = new bootstrap.Tab(tabTrigger);
                tab.show();
            }
        }
        // Guardar pestaÃ±a al hacer clic
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(btn => {
            btn.addEventListener('shown.bs.tab', e => localStorage.setItem('activeTab', e.target.id));
        });
    });

    // 2. INDICADOR DE CARGA (Spinner en el botÃ³n)
    function launchBacktest() {
        const btn = document.getElementById('btnLaunch');
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Ejecutando...`;
        document.getElementById('launchForm').submit();
    }

    // 3. FUNCIONES DEL EXPLORADOR DE ARCHIVOS
    function toggleFolder(element) {
        const nested = element.parentElement.querySelector(".nested");
        if (nested) {
            const isHidden = nested.style.display === "none";
            nested.style.display = isHidden ? "block" : "none";
            element.innerHTML = isHidden ? element.innerHTML.replace("ğŸ“", "ğŸ“‚") : element.innerHTML.replace("ğŸ“‚", "ğŸ“");
        }
    }

    function confirmDelete(url, fileName) {
        if (confirm(`Â¿EstÃ¡s seguro de que quieres borrar "${fileName}"?`)) {
            const form = document.getElementById('deleteFileForm');
            form.action = url;
            form.submit();
        }
    }
    </script>
</body>
</html>