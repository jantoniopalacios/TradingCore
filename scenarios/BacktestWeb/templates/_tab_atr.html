<div class="d-flex align-items-center gap-2 mb-3">
    <h2 class="mb-0">Par√°metros de Filtro ATR (Average True Range)</h2>
    <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#atrInfoModal">
        <i class="bi bi-info-circle"></i> ‚ÑπÔ∏è Ayuda
    </button>
</div>

<!-- Modal con informaci√≥n ATR -->
<div class="modal fade" id="atrInfoModal" tabindex="-1" aria-labelledby="atrInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="atrInfoModalLabel">üìä Average True Range (ATR) - Gu√≠a de Volatilidad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 class="mt-4 text-dark"><strong>¬øQu√© es el ATR?</strong></h6>
                <p>
                    El <strong>Average True Range (ATR)</strong> mide la volatilidad del activo calculando el promedio de los 
                    <strong>"rangos verdaderos"</strong> de los √∫ltimos N per√≠odos. Es un indicador que muestra cu√°nto se est√° moviendo 
                    el precio en promedio, independientemente de la direcci√≥n.
                </p>
                
                <div class="alert alert-info alert-sm mb-3">
                    <strong>‚ö° True Range (TR) = max(</strong><br/>
                    ‚Ä¢ High - Low (rango del d√≠a)<br/>
                    ‚Ä¢ |High - Close anterior| (gap alcista)<br/>
                    ‚Ä¢ |Low - Close anterior| (gap bajista)<br/>
                    <strong>)</strong>
                </div>

                <h6 class="text-dark"><strong>¬øPor qu√© usar ATR como filtro?</strong></h6>
                <ul class="small mb-3">
                    <li><strong>ATR bajo (< m√≠nimo)</strong>: Mercado estancado sin movimiento. Evita trades en consolidaciones donde no hay oportunidad.</li>
                    <li><strong>ATR en rango √≥ptimo</strong>: Volatilidad saludable. Equilibrio entre movimiento y estabilidad.</li>
                    <li><strong>ATR alto (> m√°ximo)</strong>: Mercado ca√≥tico o en p√°nico. Demasiado ruido: f√°cil saltarse stops.</li>
                </ul>

                <h6 class="text-dark"><strong>Par√°metros Configurables:</strong></h6>
                <ul class="small mb-3">
                    <li><strong>Per√≠odo ATR:</strong> N√∫mero de velas para calcular el promedio (t√≠picamente 14). Valores bajos ‚Üí m√°s sensible, valores altos ‚Üí m√°s suave.</li>
                    <li><strong>ATR M√≠nimo:</strong> Umbral inferior. Si ATR actual < m√≠nimo, BLOQUEA compra (mercado muy plano).</li>
                    <li><strong>ATR M√°ximo:</strong> Umbral superior. Si ATR actual > m√°ximo, BLOQUEA compra (mercado muy vol√°til).</li>
                </ul>

                <h6 class="text-dark"><strong>Estrategias Recomendadas por Activo:</strong></h6>
                <table class="table table-sm table-bordered mb-3">
                    <tr>
                        <th>Activo</th>
                        <th>Volatilidad T√≠pica</th>
                        <th>ATR Min - Max Recomendado</th>
                        <th>L√≥gica</th>
                    </tr>
                    <tr>
                        <td><strong>AAPL, JNJ</strong></td>
                        <td>Baja</td>
                        <td>1.0 - 3.0</td>
                        <td>Rango ajustado, mercados m√°s tranquilos</td>
                    </tr>
                    <tr>
                        <td><strong>NKE, COST</strong></td>
                        <td>Media</td>
                        <td>2.0 - 5.0</td>
                        <td><strong>Default (recomendado)</strong>: Balance ideal</td>
                    </tr>
                    <tr>
                        <td><strong>NVDA, TSLA</strong></td>
                        <td>Alta</td>
                        <td>3.0 - 7.0</td>
                        <td>Rango amplio, tolerancia mayor volatilidad</td>
                    </tr>
                    <tr>
                        <td><strong>BTC, Cripto</strong></td>
                        <td>Muy Alta</td>
                        <td>5.0 - 15.0</td>
                        <td>Rango muy amplio, espacio para movimientos</td>
                    </tr>
                </table>

                <h6 class="text-dark"><strong>Ejemplos Pr√°cticos:</strong></h6>
                <div class="ps-3 border-start border-warning">
                    <p class="mb-2"><strong>Escenario 1: NKE con ATR=1.5, M√≠n=2.0</strong></p>
                    <small>‚ùå Compra BLOQUEADA: "ATR 1.5 < M√≠nimo 2.0 (poca volatilidad)"<br/>Interpretaci√≥n: El mercado est√° muy plano, es mejor esperar movimiento.</small>
                    
                    <p class="mb-2 mt-3"><strong>Escenario 2: NKE con ATR=3.0, M√≠n=2.0, M√°x=5.0</strong></p>
                    <small>‚úÖ Compra PERMITIDA: "ATR en rango [2.0-5.0]"<br/>Interpretaci√≥n: Volatilidad √≥ptima, condiciones adecuadas.</small>
                    
                    <p class="mb-2 mt-3"><strong>Escenario 3: NKE con ATR=6.0, M√°x=5.0</strong></p>
                    <small>‚ùå Compra BLOQUEADA: "ATR 6.0 > M√°ximo 5.0 (exceso volatilidad)"<br/>Interpretaci√≥n: Mercado muy vol√°til/ca√≥tico, esperar normalizaci√≥n.</small>
                </div>

                <div class="alert alert-success alert-sm mt-4 mb-0">
                    <strong>üí° Consejo de Uso:</strong><br/>
                    <small>
                        Mant√©n el ATR activado como filtro de CALIDAD, similar a c√≥mo el RSI filtra por fuerza. Primero ajusta Min/Max seg√∫n el activo, 
                        luego realiza backtests comparando CON filtro vs SIN filtro. T√≠picamente ver√°s: menos trades, menos p√©rdidas por ruido, 
                        pero tambi√©n menos oportunidades. Balance es clave.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-6">
        <h4 class="mb-3 text-primary">Configuraci√≥n ATR</h4>

        <div class="row row-control align-items-center mb-3">
            <div class="col-6"><label for="atr_enabled" class="form-check-label fw-bold">Activar ATR:</label></div>
            <div class="col-4">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="atr_enabled" name="atr_enabled" value="True" 
                           {% if config.atr_enabled == 'True' or config.atr_enabled == True %}checked{% endif %}>
                </div>
            </div>
            <div class="col-2">
                <span class="text-muted small"><a href="#" title="Habilita el filtro de rango de volatilidad" data-bs-toggle="tooltip">?</a></span>
            </div>
        </div>

        <div class="row row-control align-items-center mb-3">
            <div class="col-6"><label for="atr_period" class="form-label">Per√≠odo ATR:</label></div>
            <div class="col-4">
                <input type="number" class="form-control" id="atr_period" name="atr_period" min="1" max="50" value="{{ config.atr_period if config.atr_period else 14 }}">
            </div>
            <div class="col-2">
                <span class="text-muted small"><a href="#" title="Per√≠odos para calcular el promedio (por defecto 14)" data-bs-toggle="tooltip">?</a></span>
            </div>
        </div>
        <p class="text-muted small ms-5">Rango t√≠pico: 5-20. M√°s bajo = m√°s sensible, m√°s alto = m√°s suave.</p>

        <div class="row row-control align-items-center mb-3">
            <div class="col-6"><label for="atr_min" class="form-label text-success">ATR M√≠nimo:</label></div>
            <div class="col-4">
                <input type="number" class="form-control" id="atr_min" name="atr_min" step="0.1" min="0.1" max="20.0" value="{{ config.atr_min if config.atr_min else 2.0 }}">
            </div>
            <div class="col-2">
                <span class="text-muted small"><a href="#" title="ATR debe estar por encima de este valor" data-bs-toggle="tooltip">?</a></span>
            </div>
        </div>
        <p class="text-muted small ms-5">Evita mercados estancados. Default: 2.0</p>

        <div class="row row-control align-items-center mb-2">
            <div class="col-6"><label for="atr_max" class="form-label text-danger">ATR M√°ximo:</label></div>
            <div class="col-4">
                <input type="number" class="form-control" id="atr_max" name="atr_max" step="0.1" min="0.1" max="20.0" value="{{ config.atr_max if config.atr_max else 5.0 }}">
            </div>
            <div class="col-2">
                <span class="text-muted small"><a href="#" title="ATR debe estar por debajo de este valor" data-bs-toggle="tooltip">?</a></span>
            </div>
        </div>
        <p class="text-muted small ms-5">Evita mercados ca√≥ticos. Default: 5.0</p>
    </div>

    <div class="col-6">
        <h4 class="mb-3 text-dark">Variables de Acceso R√°pido</h4>
        
        <div class="alert alert-info alert-sm mb-3">
            <strong>Presets Recomendados:</strong><br/>
            <small>
                <button type="button" class="btn btn-sm btn-outline-primary me-2 mt-2" onclick="document.getElementById('atr_min').value = 1.0; document.getElementById('atr_max').value = 3.0;">
                    Baja Vol (1.0-3.0)
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary me-2 mt-2" onclick="document.getElementById('atr_min').value = 2.0; document.getElementById('atr_max').value = 5.0;">
                    üéØ Defecto (2.0-5.0)
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="document.getElementById('atr_min').value = 3.0; document.getElementById('atr_max').value = 7.0;">
                    Alta Vol (3.0-7.0)
                </button>
            </small>
        </div>

        <div class="alert alert-warning alert-sm mb-3">
            <strong>‚ö†Ô∏è Relaci√≥n con otros filtros:</strong><br/>
            <small>
                ATR act√∫a como un filtro AND en el flujo de decisi√≥n:<br/>
                ‚Ä¢ Si ATR est√° <strong>fuera de rango</strong> ‚Üí Compra bloqueada<br/>
                ‚Ä¢ Se aplica <strong>despu√©s de RSI</strong> y <strong>antes de volumen</strong><br/>
                ‚Ä¢ Independiente de indicadores t√©cnicos (EMA, RSI, MACD, etc.)
            </small>
        </div>

        <div class="alert alert-success alert-sm">
            <strong>üí° Caso de Uso:</strong><br/>
            <small>
                Activa ATR si observas que el backtest genera muchos trades en per√≠odos estancados 
                o muy vol√°tiles. Filtra "ruido" y mejora la calidad de las operaciones.
            </small>
        </div>
    </div>
</div>
