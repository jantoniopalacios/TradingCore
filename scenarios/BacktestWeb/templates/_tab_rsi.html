<div class="d-flex align-items-center gap-2 mb-3">
    <h2 class="mb-0">Par√°metros de √çndice de Fuerza Relativa (RSI)</h2>
    <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#rsiInfoModal">
        <i class="bi bi-info-circle"></i> ‚ÑπÔ∏è Ayuda
    </button>
</div>

<!-- Modal con informaci√≥n RSI -->
<div class="modal fade" id="rsiInfoModal" tabindex="-1" aria-labelledby="rsiInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="rsiInfoModalLabel">üìà √çndice de Fuerza Relativa (RSI) - Gu√≠a Completa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>¬øQu√© es el RSI?</strong> Es un oscilador de momentum que mide la velocidad y magnitud de los cambios de precio en una escala de 0 a 100. Identifica condiciones de sobrecompra (overbought) y sobreventa (oversold).</p>

                <div class="alert alert-secondary mt-4 mb-4">
                    <strong>‚ö° Trailing Stop Loss Din√°mico por RSI</strong><br>
                    <ul class="mb-1">
                        <li>Permite definir dos porcentajes de trailing stop loss din√°mico seg√∫n el valor del RSI.</li>
                        <li>Configura un <strong>l√≠mite de RSI</strong> (por ejemplo, 40).</li>
                        <li>Si el RSI es <strong>menor o igual</strong> al l√≠mite, se aplica el <strong>primer %</strong> de trailing stop loss.</li>
                        <li>Si el RSI es <strong>mayor</strong> que el l√≠mite, se aplica el <strong>segundo %</strong> de trailing stop loss.</li>
                        <li>El stop loss se recalcula autom√°ticamente en cada vela seg√∫n el valor actual del RSI y los par√°metros configurados.</li>
                        <li>Ejemplo: Si el l√≠mite es 40, el %1 es 2% y el %2 es 0.8%, entonces:<br>
                            &nbsp;&nbsp;‚Ä¢ Si RSI ‚â§ 40, el trailing SL ser√° 2% bajo el m√°ximo.<br>
                            &nbsp;&nbsp;‚Ä¢ Si RSI &gt; 40, el trailing SL ser√° 0.8% bajo el m√°ximo.</li>
                        <li>Esto permite proteger m√°s agresivamente cuando el RSI est√° d√©bil y dejar correr la posici√≥n cuando el momentum es fuerte.</li>
                    </ul>
                    <span class="text-muted small">El trailing stop loss por RSI es totalmente autom√°tico y sustituye al trailing global solo si los par√°metros est√°n configurados.</span>
                </div>
                
                <h6 class="mt-4 text-dark"><strong>Par√°metros Configurables:</strong></h6>
                <ul class="mb-3">
                    <li><strong>Per√≠odo de C√°lculo:</strong> Por defecto 14. Ventana para calcular ganancias/p√©rdidas promedio.</li>
                    <li><strong>Nivel M√°ximo (Sobrecompra):</strong> Por defecto 70. RSI por encima indica activo "caro" o sobrecalentado.</li>
                    <li><strong>Nivel M√≠nimo (Sobreventa):</strong> Por defecto 30. RSI por debajo indica activo "barato" o sobrecastigado.</li>
                    <li><strong>Umbral de Fuerza:</strong> Por defecto 55. Nivel intermedio para detectar continuaci√≥n alcista sin llegar a sobrecompra.</li>
                </ul>
                
                <h6 class="text-dark"><strong>Se√±ales Disponibles (Activables independientemente):</strong></h6>
                
                <div class="ps-3 border-start border-info">
                    <p class="mb-2"><strong class="text-success">üü¢ COMPRA - L√≥gica OR (cualquiera activa la compra):</strong></p>
                    <ul class="small mb-3">
                        <li><strong>M√≠nimo (Giro desde Sobreventa):</strong> RSI toca valle local (< nivel m√≠nimo) y cruza hacia arriba ‚Üí Rebote despu√©s de sobrecorrecci√≥n.</li>
                        <li><strong>Ascendente:</strong> RSI est√° subiendo ‚Üí Recuperaci√≥n de momentum, entrada en recuperaci√≥n.</li>
                    </ul>
                    
                    <p class="mb-2"><strong class="text-danger">üî¥ VENTA / BLOQUEO - L√≥gica AND:</strong></p>
                    <ul class="small mb-3">
                        <li><strong>M√°ximo (Sobrecompra):</strong> RSI toca pico local (> nivel m√°ximo) ‚Üí Realizaci√≥n de ganancias + bloquea nuevas compras.</li>
                        <li><strong>Descendente:</strong> RSI est√° bajando ‚Üí P√©rdida de momentum + bloquea nuevas compras.</li>
                    </ul>
                </div>
                
                <div class="alert alert-primary alert-sm mt-3 mb-3">
                    <strong>üõë Filtro Global de Fuerza Pura (SIEMPRE ACTIVO):</strong><br>
                    <small>
                        <strong>El filtro se aplica SIEMPRE cuando RSI est√° activado:</strong><br>
                        <strong>RSI < Umbral de Fuerza ‚Üí BLOQUEA todas las compras</strong> (incluidas las de B&H, EMA, MACD y otros indicadores)<br>
                        Este filtro funciona como guardabarrera de calidad: solo permite entrar cuando el mercado tiene suficiente fuerza alcista. 
                        Similar al veto hardcoded de EMA descendente, pero basado en nivel absoluto de RSI y configurable.<br>
                        <strong>‚úÖ El umbral funciona INCLUSO SIN SWITCHES activados</strong> ‚Üí Es un filtro de calidad global.
                    </small>
                    <hr class="my-2">
                    <small>
                        <strong>üéØ Estrategias por Umbral:</strong><br>
                        ‚Ä¢ <strong>Umbral 0</strong>: Desactiva el filtro completamente. Permite compras sin restricci√≥n de fuerza.<br>
                        ‚Ä¢ <strong>Umbral 20-25</strong> (por debajo del nivel m√≠nimo 30): Agresivo, bloquea solo extremos. Permite <strong>reversi√≥n desde sobreventa</strong>.<br>
                        ‚Ä¢ <strong>Umbral 50-55</strong> (por encima del nivel m√≠nimo): Conservador, solo <strong>momentum alcista fuerte</strong>.<br>
                        <strong>üí° Tip:</strong> Ajusta el umbral seg√∫n tu perfil: agresivo (bajo) vs conservador (alto). El umbral NO requiere switches para funcionar.
                    </small>
                </div>
                
                <div class="alert alert-warning alert-sm mt-3 mb-3">
                    <strong>üí° Reflexi√≥n sobre M√°ximo + Descendente:</strong><br>
                    <small>Similar a EMA, cuando RSI toca un pico (m√°ximo), la siguiente vela suele estar m√°s baja (descendente). Ambos casi siempre ocurren juntos. Considera usar solo uno para simplificar tu estrategia.</small>
                </div>
                
                <div class="alert alert-success alert-sm mb-3">
                    <strong>‚úÖ Diferencia con EMA (Protecci√≥n Hardcoded):</strong><br>
                    <small>
                        ‚Ä¢ <strong>EMA:</strong> Tiene un <strong>veto hardcoded permanente</strong> ‚Üí Si EMA Lenta est√° descendiendo, BLOQUEA todas las compras sin importar configuraci√≥n.<br>
                        ‚Ä¢ <strong>RSI:</strong> Tiene un <strong>filtro global de Fuerza Pura (siempre activo pero configurable)</strong> ‚Üí Si RSI est√° activado Y RSI < Umbral de Fuerza, BLOQUEA todas las compras. <strong>Diferencia clave:</strong> (1) B&H funciona si NO hay switches de compra (M√≠nimo/Ascendente), (2) Puedes ajustar el umbral (incluso ponerlo en 0 para desactivarlo), (3) EMA es un veto fijo, RSI es configurable.
                    </small>
                </div>
                
                <h6 class="text-dark"><strong>Ejemplos de Combinaciones:</strong></h6>
                <ul class="small mb-3">
                    <li><strong>Umbral 50 + Sin switches:</strong> Filtro puro ‚Üí B&H funciona normalmente, pero bloquea compras si RSI < 50.<br/></li>
                    <li><strong>Umbral 25 + M√≠nimo ON:</strong> Se√±al + filtro ‚Üí Compra en valles (si RSI > 25), B&H desactivado (hay switch de compra).<br/></li>
                    <li><strong>Umbral 0 + Ascendente ON:</strong> Sin filtro + se√±al ‚Üí Compra cuando RSI sube, sin restricci√≥n de fuerza. B&H desactivado.<br/></li>
                    <li><strong>Umbral 55 + M√°ximo ON + Descendente ON:</strong> Filtro + ventas ‚Üí B&H funciona, M√°ximo/Descendente generan ventas Y bloqueos de entrada. Estrategia conservadora.<br/></li>
                </ul>
                
                <div class="alert alert-info alert-sm mb-0">
                    <strong>üí° Comportamiento CON/SIN Switches de Compra:</strong><br>
                    <small>
                        <strong>üü¢ SIN switches de compra (M√≠nimo, Ascendente OFF):</strong><br>
                        ‚Ä¢ <strong>COMPRA:</strong> ‚ùå NO genera se√±ales de entrada propias ‚Üí Solo usa B&H (EMA Lenta m√≠nimo).<br>
                        ‚Ä¢ <strong>BLOQUEOS:</strong> ‚ö†Ô∏è S√ç bloquea por UMBRAL ‚Üí Si RSI < Umbral, bloquea las compras de B&H.‚Ä¢ <strong>Resultado:</strong> B&H funciona con filtro RSI de calidad. Filtro global configurable.
                    </small>
                    <hr class="my-2">
                    <small>
                        <strong>üî¥ CON switches de compra (M√≠nimo O Ascendente ON):</strong><br>
                        ‚Ä¢ <strong>COMPRA:</strong> ‚úÖ S√ç genera se√±ales ‚Üí M√≠nimo o Ascendente generan compras propias.<br>
                        ‚Ä¢ <strong>BLOQUEOS:</strong> ‚ö†Ô∏è S√ç bloquea por UMBRAL ‚Üí Si RSI < Umbral, bloquea TODAS las compras (incluidas las de los switches).<br>
                        ‚Ä¢ <strong>B&H desactivado:</strong> Al tener switches de compra, B&H no se usa. Solo operan los switches.‚Ä¢ <strong>Resultado:</strong> RSI genera operaciones propias con filtro de calidad.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-6 border-end">
        <h4 class="mb-3 text-primary">Configuraci√≥n Principal</h4>

        <div class="row row-control align-items-center mb-3">
            <div class="col-6"><label for="rsi" class="form-check-label fw-bold">Activar RSI:</label></div>
            <div class="col-4">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="rsi" name="rsi" value="True" 
                           {% if config.rsi == 'True' %}checked{% endif %}>
                </div>
            </div>
            <div class="col-2">
                <span class="text-muted small">{% if comments.rsi %}<a href="#" title="{{ comments.rsi }}">?</a>{% endif %}</span>
            </div>
        </div>

        <div class="row row-control align-items-center mb-2">
            <div class="col-6"><label for="rsi_period" class="form-label">Per√≠odo de C√°lculo (RSI Period):</label></div>
            <div class="col-4">
                <input type="number" class="form-control" id="rsi_period" name="rsi_period" min="2" value="{{ config.rsi_period }}">
            </div>
            <div class="col-2"><span class="text-muted small">{% if comments.rsi_period %}<a href="#" title="{{ comments.rsi_period }}">?</a>{% endif %}</span></div>
        </div>

        <div class="row row-control align-items-center mb-4">
            <div class="col-6"><label for="rsi_high_level" class="form-label text-danger">Nivel M√°ximo (Sobrecompra):</label></div>
            <div class="col-4">
                <input type="number" class="form-control" id="rsi_high_level" name="rsi_high_level" min="50" max="100" value="{{ config.rsi_high_level }}">
            </div>
            <div class="col-2"><span class="text-muted small">{% if comments.rsi_high_level %}<a href="#" title="{{ comments.rsi_high_level }}">?</a>{% endif %}</span></div>
        </div>
        
        <div class="row row-control align-items-center mb-2">
            <div class="col-6"><label for="rsi_strength_threshold" class="form-label">Umbral de Fuerza:</label></div>
            <div class="col-4">
                <input type="number" class="form-control" id="rsi_strength_threshold" name="rsi_strength_threshold" min="0" max="100" value="{{ config.rsi_strength_threshold }}">
            </div>
            <div class="col-2"><span class="text-muted small">{% if comments.rsi_strength_threshold %}<a href="#" title="{{ comments.rsi_strength_threshold }}">?</a>{% endif %}</span></div>
        </div>
        <p class="text-muted small ms-5">Usado para buscar continuaci√≥n (por encima de este valor).</p>

        <div class="row row-control align-items-center mb-2">
            <div class="col-6"><label for="rsi_low_level" class="form-label text-success">Nivel M√≠nimo (Sobreventa):</label></div>
            <div class="col-4">
                <input type="number" class="form-control" id="rsi_low_level" name="rsi_low_level" min="0" max="50" value="{{ config.rsi_low_level }}">
            </div>
            <div class="col-2"><span class="text-muted small">{% if comments.rsi_low_level %}<a href="#" title="{{ comments.rsi_low_level }}">?</a>{% endif %}</span></div>
        </div>
        <p class="text-muted small ms-5">Usado como filtro de precio 'barato' antes de la ruptura. (Sugerido 40/45).</p>
        <p class="text-muted small ms-5 text-danger">‚ö†Ô∏è Se asume que esta variable es un filtro y NO la condici√≥n principal de Venta (usa 'Overbought').</p>
    </div>

    <div class="col-6">
        <h4 class="mb-3 text-dark">Se√±ales de Compra y Venta</h4>
        <p class="text-muted small">Activa los tipos de se√±al que deseas usar. Ver modal de ayuda para detalles.</p>

        <h5 class="mt-4 text-success">üü¢ Se√±ales de Compra (OR)</h5>
        
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="rsi_minimo" name="rsi_minimo" value="true" 
                   {% if config.get('rsi_minimo') == 'True' or config.get('rsi_minimo') == True %}checked{% endif %}>
            <label class="form-check-label fw-bold" for="rsi_minimo">
                M√≠nimo (Giro desde Sobreventa)
            </label>
        </div>

        <div class="form-check form-switch mb-4">
            <input class="form-check-input" type="checkbox" id="rsi_ascendente" name="rsi_ascendente" value="true" 
                   {% if config.get('rsi_ascendente') == 'True' or config.get('rsi_ascendente') == True %}checked{% endif %}>
            <label class="form-check-label fw-bold" for="rsi_ascendente">
                Ascendente (Recuperaci√≥n)
            </label>
        </div>

        <hr>
        <hr>
        <h6 class="text-primary">Trailing Stop Loss Din√°mico por RSI</h6>
        <div class="row row-control align-items-center mb-2">
            <div class="col-6">
                <label for="rsi_trailing_limit" class="form-label">L√≠mite RSI para Trailing:</label>
                <span class="text-muted small">Si RSI ‚â§ este valor, se aplica el primer %; si RSI &gt; este valor, el segundo %.</span>
            </div>
            <div class="col-4">
                <input type="number" class="form-control" id="rsi_trailing_limit" name="rsi_trailing_limit" min="0" max="100" value="{{ config.rsi_trailing_limit }}">
            </div>
            <div class="col-2">
                <span class="text-muted small">{%- if comments.rsi_trailing_limit -%}<a href="#" title="{{ comments.rsi_trailing_limit }}">?</a>{%- endif -%}</span>
            </div>
        </div>
        <div class="row row-control align-items-center mb-2">
            <div class="col-6">
                <label for="trailing_pct_below" class="form-label">% Trailing SL si RSI ‚â§ l√≠mite:</label>
            </div>
            <div class="col-4">
                <input type="number" class="form-control" id="trailing_pct_below" name="trailing_pct_below" min="0" max="100" step="0.01" value="{{ config.trailing_pct_below }}">
            </div>
            <div class="col-2">
                <span class="text-muted small">%</span>
            </div>
        </div>
        <div class="row row-control align-items-center mb-2">
            <div class="col-6">
                <label for="trailing_pct_above" class="form-label">% Trailing SL si RSI &gt; l√≠mite:</label>
            </div>
            <div class="col-4">
                <input type="number" class="form-control" id="trailing_pct_above" name="trailing_pct_above" min="0" max="100" step="0.01" value="{{ config.trailing_pct_above }}">
            </div>
            <div class="col-2">
                <span class="text-muted small">%</span>
            </div>
        </div>
        <p class="text-muted small ms-5">El trailing stop loss se ajusta autom√°ticamente seg√∫n el RSI y los valores configurados.</p>
        <p class="text-muted small ms-5">Estos stops por RSI tienen prioridad m√°xima y sobrescriben cualquier otro stop loss cuando est√°n configurados.</p>

        <h5 class="mt-4 text-danger">üî¥ Se√±ales de Venta (OR) / Bloqueos (AND)</h5>
        
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="rsi_maximo" name="rsi_maximo" value="true" 
                   {% if config.get('rsi_maximo') == 'True' or config.get('rsi_maximo') == True %}checked{% endif %}>
            <label class="form-check-label fw-bold" for="rsi_maximo">
                M√°ximo (Sobrecompra)
            </label>
        </div>

        <div class="form-check form-switch mb-4">
            <input class="form-check-input" type="checkbox" id="rsi_descendente" name="rsi_descendente" value="true" 
                   {% if config.get('rsi_descendente') == 'True' or config.get('rsi_descendente') == True %}checked{% endif %}>
            <label class="form-check-label fw-bold" for="rsi_descendente">
                Descendente (P√©rdida Momentum)
            </label>
        </div>
    </div>
</div>