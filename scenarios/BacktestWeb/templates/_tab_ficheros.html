{% macro render_tree(tree, current_path="") %}
  <ul class="list-unstyled ms-3 border-start border-secondary border-opacity-25 ps-2">
    {% for item in tree %}
      {% set name = item.name %}
      {% set is_dir = item.is_dir %}
      {% set children = item.children %}
      {% set date = item.date if not is_dir else "" %}
      {% set item_path = (current_path + "/" + name) if current_path else name %}
      
      {% set is_log_related = (name.lower() == "trading_app.log" or name.lower() == "logs") %}
      {% if not is_log_related or (is_log_related and session.get('user_mode') == 'admin') %}
        
        <li class="mb-1 py-1">
          {% if is_dir %}
            <div class="folder-row d-flex align-items-center py-1 rounded hover-bg-dark" onclick="toggleFolder(this)" style="cursor: pointer;">
              <span class="folder-icon me-2">üìÅ</span>
              <strong class="text-info small fw-bold">{{ name }}</strong>
            </div>
            <div class="nested" style="display: none;">
              {{ render_tree(children, item_path) }}
            </div>
          {% else %}
            <div class="file-row-grid rounded px-2 hover-bg-dark">
              <div class="d-flex align-items-center overflow-hidden">
                <i class="bi bi-file-earmark-code text-info me-2"></i>
                <a href="javascript:void(0);" 
                   onclick="openFile('{{ url_for('main.view_file', path=item_path) }}', '{{ name }}')"
                   class="text-decoration-none text-white small fw-bold text-truncate">
                   {{ name }}
                </a>
              </div>
              
              <div class="text-end">
                <span class="timestamp-yellow font-monospace d-none d-md-inline">{{ date }}</span>
              </div>

              <div class="d-flex justify-content-end gap-2">
                <a href="{{ url_for('main.view_file', path=item_path) }}" download="{{ name }}" 
                   class="btn btn-link btn-sm text-secondary p-0 hover-info">
                   <i class="bi bi-download"></i>
                </a>
                <button type="button" class="btn btn-link btn-sm text-secondary p-0 hover-danger" 
                        onclick="confirmDelete(event, '{{ url_for('main.delete_file', path=item_path) }}', '{{ name }}')">
                    <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          {% endif %}
        </li>
      {% endif %}
    {% endfor %}
  </ul>
{% endmacro %}

{% if session.get('user_mode') == 'admin' %}
    <div id="file-viewer-admin" class="card bg-black border-secondary shadow-lg overflow-hidden" style="display: flex; flex-direction: column; height: 600px;">
        
        <div class="card-header bg-black border-bottom border-secondary p-3" style="flex: 0 auto; z-index: 10;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-info small fw-bold text-uppercase tracking-wider">
                    <i class="bi bi-hdd-network me-2"></i>Sistema de Archivos (Admin)
                </h5>
            </div>
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-dark border-secondary text-secondary border-end-0"><i class="bi bi-search"></i></span>
                <input type="text" id="adminSearch" class="form-control bg-dark border-secondary text-white border-start-0" placeholder="Filtrar por nombre o fecha...">
            </div>
        </div>
        
        <div class="card-body p-0 custom-scrollbar" style="flex: 1; overflow-y: auto;">
            <div class="p-3">
                {% if file_tree %}
                    {{ render_tree(file_tree) }}
                {% else %}
                    <p class="text-muted text-center py-5 small">No hay archivos.</p>
                {% endif %}
            </div>
        </div>
    </div>
{% endif %}

<style>
    /* COLORES BASE */
    .bg-black { background-color: #000000 !important; }
    .text-white { color: #ffffff !important; }
    .text-info { color: #00d4ff !important; } /* Cian para iconos y carpetas */
    
    /* TIMESTAMP AMARILLO - Estilo terminal */
    .timestamp-yellow {
        color: #ffcc00 !important; /* Amarillo s√≥lido y brillante */
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

    /* GRID DE ALINEACI√ìN */
    .file-row-grid {
        display: grid;
        grid-template-columns: 1fr 160px 70px;
        align-items: center;
        gap: 10px;
        min-height: 38px;
        border-bottom: 1px solid #111;
    }

    /* HOVERS */
    .hover-bg-dark:hover { background-color: #111 !important; }
    .hover-info:hover { color: #00d4ff !important; }
    .hover-danger:hover { color: #ff4444 !important; }

    /* SCROLLBAR */
    .custom-scrollbar::-webkit-scrollbar { width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #ffcc00; }
</style>

<script>
document.getElementById('adminSearch')?.addEventListener('input', function(e) {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('li').forEach(li => {
        const text = li.textContent.toLowerCase();
        li.style.display = text.includes(term) ? "" : "none";
    });
});
</script>