{% macro render_tree(tree, current_path="") %}
  <ul class="list-unstyled ms-3">
    {% for name, is_dir, children, date in tree %}
      {% set item_path = (current_path + "/" + name) if current_path else name %}
      <li class="mb-1">
        {% if is_dir %}
          <span class="folder" onclick="toggleFolder(this)" style="cursor: pointer; font-weight: bold; color: #f39c12;">
            ğŸ“ <strong>{{ name }}</strong> 
          </span>
          <div class="nested" style="display: none;">
            {{ render_tree(children, item_path) }}
          </div>
        {% else %}
          <div class="d-flex justify-content-between align-items-center border-bottom pb-1" style="max-width: 600px;">
            <div>
                <a href="{{ url_for('main.view_file', path=item_path) }}" 
                   onclick="this.href=this.href.split('?')[0] + '?t=' + new Date().getTime()" 
                   target="_blank" class="me-2 text-decoration-none" style="color: #2980b9;">
                    ğŸ“„ {{ name }}
                </a>
                <small class="text-muted" style="font-size: 0.75rem; font-family: monospace;">{{ date }}</small>
            </div>
            
            <button type="button" class="btn btn-link text-danger p-0" title="Borrar archivo"
                    onclick="confirmDelete('{{ url_for('main.delete_file', path=item_path) }}', '{{ name }}')">
                <i class="bi bi-trash3-fill"></i>
            </button>
          </div>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% endmacro %}

<div id="file-viewer" class="mt-3 p-3 border rounded shadow-sm bg-light">
    <h5 class="border-bottom pb-2 mb-3 text-primary">
        <i class="bi bi-hdd-rack me-2"></i>Estructura del Directorio: <span class="fw-bold">{{ backtesting_dir_name }}</span>
    </h5>
    
    {% if file_tree %}
        <div class="file-tree-container">
            {{ render_tree(file_tree) }}
        </div>
    {% else %}
        <div class="alert alert-warning">
            âš ï¸ La carpeta **{{ backtesting_dir_name }}** estÃ¡ vacÃ­a o no existe.
        </div>
    {% endif %}
</div>