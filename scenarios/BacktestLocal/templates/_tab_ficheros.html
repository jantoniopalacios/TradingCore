{% macro render_tree(tree, current_path="") %}
  <ul class="list-unstyled ms-3 border-start border-secondary border-opacity-25 ps-2">
    {% for item in tree %}
      {# Extraemos los valores del diccionario enviado desde el servidor #}
      {% set name = item.name %}
      {% set is_dir = item.is_dir %}
      {% set children = item.children %}
      {% set date = item.date if not is_dir else "" %}
      
      {% set item_path = (current_path + "/" + name) if current_path else name %}
      
      {# L√≥gica de Seguridad de Acceso #}
      {% set is_log_related = (name.lower() == "trading_app.log" or name.lower() == "logs") %}
      {% if not is_log_related or (is_log_related and session.get('user_mode') == 'admin') %}
        
        <li class="mb-1 py-1">
          {% if is_dir %}
            {# Fila de Carpeta #}
            <div class="folder-row d-flex align-items-center py-1 rounded" onclick="toggleFolder(this)" style="cursor: pointer;">
              <span class="folder-icon me-2">üìÅ</span>
              <strong class="text-light-emphasis small">{{ name }}</strong>
            </div>
            {# La clase 'nested' es vital para el JS de index.html #}
            <div class="nested" style="display: none;">
              {{ render_tree(children, item_path) }}
            </div>
          {% else %}
            {# Fila de Archivo #}
            <div class="file-row d-flex justify-content-between align-items-center rounded px-2 hover-bg">
              <div class="d-flex align-items-center overflow-hidden">
                <i class="bi bi-file-earmark-code text-info me-2"></i>
                <a href="javascript:void(0);" 
                   onclick="openFile('{{ url_for('main.view_file', path=item_path) }}', '{{ name }}')"
                   class="text-decoration-none text-light opacity-75 small text-truncate">
                   {{ name }}
                </a>
                <span class="ms-3 text-muted smaller font-monospace d-none d-md-inline">{{ date }}</span>
              </div>
              
              <div class="file-actions d-flex gap-2">
                <a href="{{ url_for('main.view_file', path=item_path) }}" download="{{ name }}" 
                   class="btn btn-link btn-sm text-secondary p-0 hover-primary" title="Descargar">
                   <i class="bi bi-download"></i>
                </a>
                <button type="button" class="btn btn-link btn-sm text-secondary p-0 hover-danger" 
                        onclick="confirmDelete('{{ url_for('main.delete_file', path=item_path) }}', '{{ name }}')" title="Eliminar">
                    <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          {% endif %}
        </li>
      {% endif %}
    {% endfor %}
  </ul>
{% endmacro %}

<div id="file-viewer" class="card bg-dark border-secondary shadow-lg">
    <div class="card-header bg-black border-bottom border-secondary d-flex justify-content-between align-items-center">
        <h5 class="mb-0 text-primary small fw-bold text-uppercase tracking-wider">
            <i class="bi bi-hdd-network me-2"></i>Sistema de Archivos
        </h5>
        <span class="badge bg-secondary opacity-75 small">Usuario: {{ session.get('user_mode') }}</span>
    </div>
    
    <div class="card-body">
        {% if file_tree %}
            <div class="file-tree-container custom-scrollbar" style="max-height: 500px; overflow-y: auto;">
                {{ render_tree(file_tree) }}
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-folder-x fa-3x text-secondary opacity-25 mb-3"></i>
                <p class="text-muted">No hay archivos disponibles para mostrar.</p>
            </div>
        {% endif %}
    </div>
</div>

<style>
    /* Estilos para el explorador */
    .hover-bg:hover { background-color: rgba(255, 255, 255, 0.05); }
    .hover-primary:hover { color: #0d6efd !important; }
    .hover-danger:hover { color: #dc3545 !important; }
    .smaller { font-size: 0.75rem; }
    .tracking-wider { letter-spacing: 1px; }
    
    .folder-row:hover { background-color: rgba(243, 156, 18, 0.1); }
    
    /* Espaciado para la anidaci√≥n */
    .nested { margin-left: 20px; }

    /* Scrollbar minimalista */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f4750; border-radius: 10px; }
</style>